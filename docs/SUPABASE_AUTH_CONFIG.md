# Supabase é‚®ç®±éªŒè¯é…ç½®æŒ‡å—

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼ä½ å¦‚ä½•é…ç½® Supabase ä½¿é‚®ç®±éªŒè¯é“¾æ¥æ­£ç¡®æŒ‡å‘ç”Ÿäº§ç¯å¢ƒæˆ–å¼€å‘ç¯å¢ƒã€‚

---

## ğŸ”´ é—®é¢˜æè¿°

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSupabase å‘é€çš„é‚®ç®±éªŒè¯é“¾æ¥ä¼šä½¿ç”¨ `localhost` ä½œä¸º hostï¼Œå¯¼è‡´ç”Ÿäº§ç¯å¢ƒç”¨æˆ·æ— æ³•æ­£å¸¸å®Œæˆé‚®ç®±éªŒè¯ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

éœ€è¦åœ¨ Supabase é¡¹ç›®ä¸­é…ç½®æ­£ç¡®çš„ **Site URL** å’Œ **Redirect URLs**ã€‚

---

## ğŸ“‹ é…ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç™»å½• Supabase Dashboard

1. è®¿é—® [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©ä½ çš„é¡¹ç›®ï¼ˆVibeCodingDemoï¼‰
3. è¿›å…¥é¡¹ç›®ç®¡ç†é¢æ¿

---

### ç¬¬äºŒæ­¥ï¼šé…ç½® URL è®¾ç½®

#### 1. æ‰“å¼€è®¤è¯è®¾ç½®

- åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œç‚¹å‡» **âš™ï¸ Authentication**
- é€‰æ‹© **URL Configuration**

#### 2. é…ç½® Site URL

æ‰¾åˆ° **Site URL** å­—æ®µï¼Œæ ¹æ®ç¯å¢ƒè®¾ç½®ï¼š

**ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ï¼š**
```
https://cafe9k.github.io/VibeCodingDemo
```

**æˆ–å¼€å‘ç¯å¢ƒï¼š**
```
http://test.ctripcorp.com:5173
```

> ğŸ’¡ **è¯´æ˜**ï¼šSite URL æ˜¯ Supabase é»˜è®¤ä½¿ç”¨çš„é‡å®šå‘åŸºç¡€ URL

#### 3. é…ç½® Redirect URLs

æ‰¾åˆ° **Redirect URLs** å­—æ®µï¼Œæ·»åŠ ä»¥ä¸‹æ‰€æœ‰ URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š

```
https://cafe9k.github.io/VibeCodingDemo/auth/callback
http://test.ctripcorp.com:5173/auth/callback
http://localhost:5173/auth/callback
```

> ğŸ’¡ **è¯´æ˜**ï¼šæ·»åŠ å¤šä¸ª URL å¯ä»¥åŒæ—¶æ”¯æŒç”Ÿäº§ç¯å¢ƒã€å¼€å‘ç¯å¢ƒå’Œæœ¬åœ°æµ‹è¯•

#### 4. ä¿å­˜é…ç½®

- ç‚¹å‡»é¡µé¢åº•éƒ¨çš„ **Save** æŒ‰é’®
- ç­‰å¾…é…ç½®ç”Ÿæ•ˆï¼ˆé€šå¸¸ç«‹å³ç”Ÿæ•ˆï¼‰

---

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®é‚®ä»¶æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦è‡ªå®šä¹‰éªŒè¯é‚®ä»¶çš„æ ·å¼å’Œå†…å®¹ï¼š

1. åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œç‚¹å‡» **âš™ï¸ Authentication**
2. é€‰æ‹© **Email Templates**
3. é€‰æ‹© **Confirm signup** æ¨¡æ¿
4. è‡ªå®šä¹‰é‚®ä»¶å†…å®¹ï¼ˆå¯ä»¥ä½¿ç”¨ HTMLï¼‰
5. ç¡®ä¿é‚®ä»¶ä¸­åŒ…å« `{{ .ConfirmationURL }}` å˜é‡
6. ç‚¹å‡» **Save** ä¿å­˜

**é»˜è®¤æ¨¡æ¿ç¤ºä¾‹ï¼š**
```html
<h2>ç¡®è®¤æ‚¨çš„æ³¨å†Œ</h2>
<p>è¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥å®Œæˆæ³¨å†Œï¼š</p>
<p><a href="{{ .ConfirmationURL }}">ç¡®è®¤é‚®ç®±</a></p>
```

---

## ğŸ§ª éªŒè¯é…ç½®

### æµ‹è¯•æµç¨‹

1. **æ³¨å†Œæ–°ç”¨æˆ·**
   - è®¿é—® https://cafe9k.github.io/VibeCodingDemo/register
   - ä½¿ç”¨çœŸå®é‚®ç®±æ³¨å†Œï¼ˆæ¨èä½¿ç”¨ Gmail æˆ–å…¶ä»–å¸¸ç”¨é‚®ç®±ï¼‰
   - æäº¤æ³¨å†Œè¡¨å•

2. **æ£€æŸ¥é‚®ä»¶**
   - æ‰“å¼€é‚®ç®±ï¼ŒæŸ¥æ‰¾æ¥è‡ª Supabase çš„éªŒè¯é‚®ä»¶
   - æ£€æŸ¥é‚®ä»¶ä¸­çš„éªŒè¯é“¾æ¥æ˜¯å¦æŒ‡å‘æ­£ç¡®çš„åŸŸå

3. **ç‚¹å‡»éªŒè¯é“¾æ¥**
   - ç‚¹å‡»é‚®ä»¶ä¸­çš„éªŒè¯é“¾æ¥
   - åº”è¯¥è·³è½¬åˆ° `https://cafe9k.github.io/VibeCodingDemo/auth/callback`
   - é¡µé¢æ˜¾ç¤º"éªŒè¯æˆåŠŸ"å¹¶è‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ

4. **ç™»å½•æµ‹è¯•**
   - ä½¿ç”¨éªŒè¯åçš„é‚®ç®±å’Œå¯†ç ç™»å½•
   - ç¡®è®¤å¯ä»¥æ­£å¸¸è®¿é—®ç”¨æˆ·ä¸­å¿ƒå’Œè®¢å•é¡µé¢

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### æœ¬åœ°å¼€å‘

å¦‚æœåœ¨æœ¬åœ°å¼€å‘æ—¶æµ‹è¯•é‚®ç®±éªŒè¯ï¼Œå¯ä»¥ï¼š

**æ–¹æ³• 1ï¼šä½¿ç”¨ test.ctripcorp.comï¼ˆæ¨èï¼‰**
- ç¡®ä¿ hosts æ–‡ä»¶å·²é…ç½®ï¼š`127.0.0.1  test.ctripcorp.com`
- å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š`npm run dev`
- è®¿é—®ï¼šhttp://test.ctripcorp.com:5173

**æ–¹æ³• 2ï¼šä¸´æ—¶ä¿®æ”¹ Site URL**
- åœ¨ Supabase Dashboard ä¸­å°† Site URL ä¸´æ—¶æ”¹ä¸º `http://localhost:5173`
- æµ‹è¯•å®Œæˆåè®°å¾—æ”¹å›ç”Ÿäº§ URL

---

## ğŸ“Š é…ç½®æ‘˜è¦

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| **Site URL** | `https://cafe9k.github.io/VibeCodingDemo` | ç”Ÿäº§ç¯å¢ƒä¸» URL |
| **Redirect URLs** | è§ä¸Šæ–‡åˆ—è¡¨ | æ”¯æŒå¤šç¯å¢ƒçš„å›è°ƒ URL |
| **Email Confirmation** | âœ… å¯ç”¨ | ç”¨æˆ·æ³¨å†Œéœ€è¦é‚®ç®±éªŒè¯ |
| **Callback Route** | `/auth/callback` | åº”ç”¨å†…çš„éªŒè¯å›è°ƒè·¯ç”± |

---

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. éªŒè¯é“¾æ¥è¿˜æ˜¯æŒ‡å‘ localhostï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- Supabase é…ç½®æœªä¿å­˜
- æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ session

**è§£å†³æ–¹æ³•ï¼š**
- é‡æ–°æ£€æŸ¥ Supabase Dashboard çš„é…ç½®
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼
- é‡å¯å¼€å‘æœåŠ¡å™¨

### 2. ç‚¹å‡»éªŒè¯é“¾æ¥åæ˜¾ç¤º 404ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- å›è°ƒè·¯ç”±æœªæ­£ç¡®é…ç½®
- è·¯ç”± basename é…ç½®é—®é¢˜

**è§£å†³æ–¹æ³•ï¼š**
- ç¡®è®¤ `src/App.jsx` ä¸­åŒ…å« `/auth/callback` è·¯ç”±
- æ£€æŸ¥ `main.jsx` ä¸­çš„ `basename` é…ç½®

### 3. éªŒè¯æˆåŠŸä½†æ— æ³•è‡ªåŠ¨ç™»å½•ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- Session è®¾ç½®å¤±è´¥
- è®¤è¯çŠ¶æ€æœªåŒæ­¥

**è§£å†³æ–¹æ³•ï¼š**
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
- æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- æ¸…é™¤ localStorage åé‡æ–°ç™»å½•

### 4. æ”¶ä¸åˆ°éªŒè¯é‚®ä»¶ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- é‚®ç®±åœ°å€é”™è¯¯
- é‚®ä»¶è¢«è¯†åˆ«ä¸ºåƒåœ¾é‚®ä»¶
- Supabase é‚®ä»¶æœåŠ¡é™åˆ¶

**è§£å†³æ–¹æ³•ï¼š**
- æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹
- ä½¿ç”¨å¸¸è§é‚®ç®±æœåŠ¡ï¼ˆGmailã€Outlook ç­‰ï¼‰
- åœ¨å¼€å‘é˜¶æ®µå¯ä»¥ä¸´æ—¶å…³é—­é‚®ç®±éªŒè¯åŠŸèƒ½

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - Site URL ä½¿ç”¨ç”Ÿäº§åŸŸå
   - åŒæ—¶é…ç½®ç”Ÿäº§å’Œå¼€å‘çš„ Redirect URLs
   - å¯ç”¨é‚®ç®±éªŒè¯å¢å¼ºå®‰å…¨æ€§

2. **å¼€å‘ç¯å¢ƒé…ç½®**
   - ä½¿ç”¨ test.ctripcorp.com é¿å…è·¨åŸŸé—®é¢˜
   - ä¸´æ—¶æµ‹è¯•æ—¶å¯ä»¥å…³é—­é‚®ç®±éªŒè¯
   - ä½¿ç”¨çœŸå®é‚®ç®±æµ‹è¯•å®Œæ•´æµç¨‹

3. **å®‰å…¨å»ºè®®**
   - ä¸è¦åœ¨ Redirect URLs ä¸­æ·»åŠ ä¸å—ä¿¡ä»»çš„åŸŸå
   - å®šæœŸæ£€æŸ¥ Supabase çš„å®‰å…¨æ—¥å¿—
   - ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase Auth å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs/guides/auth)
- [Email Configuration Guide](https://supabase.com/docs/guides/auth/auth-email)
- [é¡¹ç›®å®Œæ•´æ–‡æ¡£](./README.md)

---

## ğŸ’¡ æŠ€æœ¯è¯´æ˜

### ä»£ç å®ç°

**1. æ³¨å†Œæ—¶è®¾ç½®é‡å®šå‘ URL (`src/store/useAuthStore.js`)**

```javascript
signUp: async (email, password, nickname) => {
  // æ ¹æ®ç¯å¢ƒåŠ¨æ€è®¾ç½®é‡å®šå‘ URL
  const redirectTo = import.meta.env.PROD 
    ? 'https://cafe9k.github.io/VibeCodingDemo/auth/callback'
    : 'http://test.ctripcorp.com:5173/auth/callback'
  
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      emailRedirectTo: redirectTo,  // å…³é”®é…ç½®
      data: { nickname },
    },
  })
  if (error) throw error
  return data
}
```

**2. éªŒè¯å›è°ƒå¤„ç† (`src/pages/Auth/AuthCallback.jsx`)**

```javascript
// ä» URL hash ä¸­æå– token
const hashParams = new URLSearchParams(window.location.hash.substring(1))
const accessToken = hashParams.get('access_token')
const refreshToken = hashParams.get('refresh_token')

// è®¾ç½® session
await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
})
```

---

## âœ… é…ç½®å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] Supabase Site URL å·²è®¾ç½®ä¸ºç”Ÿäº§åŸŸå
- [ ] Redirect URLs åŒ…å«æ‰€æœ‰ç¯å¢ƒçš„å›è°ƒåœ°å€
- [ ] `/auth/callback` è·¯ç”±å·²æ·»åŠ åˆ° App.jsx
- [ ] AuthCallback ç»„ä»¶æ­£ç¡®å¤„ç†éªŒè¯é€»è¾‘
- [ ] å·²æµ‹è¯•å®Œæ•´çš„æ³¨å†Œ-éªŒè¯-ç™»å½•æµç¨‹
- [ ] éªŒè¯é‚®ä»¶ä¸­çš„é“¾æ¥æŒ‡å‘æ­£ç¡®çš„åŸŸå

---

**é…ç½®å®Œæˆåï¼Œé‚®ç®±éªŒè¯æµç¨‹åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—æˆ– Supabase Dashboard çš„æ—¥å¿—é¢æ¿ã€‚

